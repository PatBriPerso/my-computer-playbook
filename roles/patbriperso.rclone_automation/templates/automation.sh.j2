#!/usr/bin/env bash
set -euo pipefail

#######################################
# CONFIGURATION
#######################################

NAME="{{ automation.name }}"
TYPE="{{ automation.type }}"
SOURCE="{{ automation.source }}"
DEST="{{ automation.destination }}"

RCLONE_BIN="{{ rclone_automation_bin }}"

LOG_DIR="{{ ansible_env.HOME }}/.cache/rclone"
TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
LOG_FILE="$LOG_DIR/$NAME-$TIMESTAMP.log"

#######################################
# OPTIONS PAR D√âFAUT
#######################################

DRY_RUN=true
DRY_RUN_TEXT=""
SHOW_PROGRESS=true
INIT=false

#######################################
# PARSE DES ARGUMENTS
#######################################

usage() {
  cat <<EOF
Usage: $0 [options]

Options:
  --apply        Ex√©cute r√©ellement la synchronisation (d√©sactive --dry-run)
  --init         Initialise bisync (√©quivalent --resync)
  --no-progress   D√©sactive l'affichage de la progression
  -h, --help     Affiche cette aide

Par d√©faut, le script s'ex√©cute en --dry-run avec affichage de la progression.
EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --apply) DRY_RUN=false ;;
    --init) INIT=true ;;
    --no-progress) SHOW_PROGRESS=false ;;
    -h|--help) usage; exit 0 ;;
    *) echo "Unknown option: $1"; usage; exit 1 ;;
  esac
  shift
done

#######################################
# PR√âPARATION
#######################################

mkdir -p "$LOG_DIR"

# Options de base
RCLONE_OPTS=(
  "$TYPE"
  "$SOURCE"
  "$DEST"
  --log-file "$LOG_FILE"
  --log-level INFO
  --metadata
  --fix-case
  --fast-list
)

{% if automation.exclusions is defined and automation.exclusions | length > 0 %}
# Exclusions
RCLONE_OPTS+=(
{% for pattern in automation.exclusions %}
  --exclude "{{ pattern }}"
{% endfor %}
)
{% endif %}

{% if automation.extra_options is defined and automation.extra_options | length > 0 %}
# Options rclone suppl√©mentaires
RCLONE_OPTS+=(
{% for opt in automation.extra_options %}
  {{ opt | quote }}
{% endfor %}
)
{% endif %}

{% if automation.type == "sync" %}
# Param√®tres suppl√©mentaires pour sync
RCLONE_OPTS+=(
  --create-empty-src-dirs
)
{% endif %}

{% if automation.type == "bisync" %}
# Param√®tres suppl√©mentaires pour bisync
RCLONE_OPTS+=(
  --create-empty-src-dirs
  --compare size,modtime,checksum
  --slow-hash-sync-only
  --resilient
)
{% endif %}

if [[ "$INIT" == true ]]; then
  RCLONE_OPTS+=(--resync)
fi

if [[ "$DRY_RUN" == true ]]; then
  RCLONE_OPTS+=(--dry-run)
  DRY_RUN_TEXT="(dry-run)"
fi

if [[ "$SHOW_PROGRESS" == true ]]; then
  RCLONE_OPTS+=(--progress)
fi

#######################################
# NETTOYAGE DES LOGS (> 30 jours)
#######################################

find "$LOG_DIR" -type f -name "automation-*.log" -mtime +30 -delete

#######################################
# LIEN VERS DERNIER LOG
#######################################

touch "$LOG_FILE"
ln -sf "$LOG_FILE" "$LOG_DIR/$NAME-latest.log"

#######################################
# INFO AVANT EX√âCUTION
#######################################

echo "======================================"
echo "$NAME"
echo "Type  : $TYPE"
echo "Source: $SOURCE"
echo "Dest  : $DEST"
echo "Init  : $INIT"
echo "DryRun: $DRY_RUN"
echo "Log   : $LOG_FILE"
{% if automation.exclusions is defined and automation.exclusions | length > 0 %}
echo "Exclusions:"
{% for pattern in automation.exclusions %}
echo "  - {{ pattern }}"
{% endfor %}
{% endif %}
{% if automation.extra_options is defined and automation.extra_options | length > 0 %}
echo "Options rclone suppl√©mentaires:"
{% for opt in automation.extra_options %}
echo "  {{ opt | quote }}"
{% endfor %}
{% endif %}
echo "======================================"

#######################################
# EX√âCUTION
#######################################

set +e
"$RCLONE_BIN" "${RCLONE_OPTS[@]}"
RCLONE_RC=$?
set -e

#######################################
# D√âTECTION DES NOTIFICATIONS
#######################################

NOTIFY_AVAILABLE=true

if ! command -v notify-send >/dev/null 2>&1; then
  NOTIFY_AVAILABLE=false
fi

if [[ "$NOTIFY_AVAILABLE" == false ]]; then
  echo "======================================"
  echo "‚ö†Ô∏è  notify-send n'est pas install√©."
  echo "Pour activer les notifications : sudo apt install libnotify-bin"
  echo "======================================"
fi

#######################################
# NOTIFICATION ERREUR
#######################################

if (( RCLONE_RC != 0 )); then
  if [[ "$NOTIFY_AVAILABLE" == true ]]; then
    ACTION=$(notify-send \
      -u critical \
      --wait \
      --action="open=Ouvrir le log" \
      "‚ùå $NAME ‚Äì ERREUR $DRY_RUN_TEXT" \
      "La synchronisation a √©chou√© (code $RCLONE_RC). Voir $LOG_FILE"
    )

    case "$ACTION" in
      open)
        xdg-open "$LOG_FILE"
        ;;
    esac
  else
    echo "======================================"
    echo "La synchronisation a √©chou√© (code $RCLONE_RC). $DRY_RUN_TEXT"
    echo "Log: $LOG_FILE"
    echo "======================================"
  fi
fi

#######################################
# NOTIFICATION (SI CHANGEMENTS)
#######################################

# Valeurs par d√©faut
TRANSFERRED=0
DELETED=0
RENAMED=0
ELAPSED=""

# Exemples de lignes attendues :
# Transferred:            6 / 6, 100%
# Deleted:                2 (files), 0 (dirs), 74 B (freed)
# Renamed:                2
# Elapsed time:      2m24.5s

# Transferred (nombre de fichiers)
if grep -q "^Transferred:" "$LOG_FILE"; then
  TRANSFERRED=$(grep "^Transferred:" "$LOG_FILE" | tail -n 1 | awk '{print $2}')
fi

# Deleted (fichiers uniquement)
if grep -q "^Deleted:" "$LOG_FILE"; then
  DELETED=$(grep "^Deleted:" "$LOG_FILE" | tail -n 1 | awk '{print $2}')
fi

# Renamed
if grep -q "^Renamed:" "$LOG_FILE"; then
  RENAMED=$(grep "^Renamed:" "$LOG_FILE" | tail -n 1 | awk '{print $2}')
fi

# Elapsed time
if grep -q "^Elapsed time:" "$LOG_FILE"; then
  ELAPSED=$(grep "^Elapsed time:" "$LOG_FILE" | tail -n 1 | sed 's/Elapsed time:[[:space:]]*//')
fi

TOTAL=$((TRANSFERRED + DELETED + RENAMED))

if (( TOTAL > 0 )); then
  if [[ "$NOTIFY_AVAILABLE" == true ]]; then
    notify-send \
      "$NAME termin√©e $DRY_RUN_TEXT" \
      "‚è± Dur√©e : $ELAPSED  |  üì§ Transf√©r√©s : $TRANSFERRED  |  üóë Supprim√©s : $DELETED  |  üîÅ Renomm√©s : $RENAMED"
  else
    echo "======================================"
    echo "$NAME termin√©e $DRY_RUN_TEXT"
    echo "Dur√©e : $ELAPSED"
    echo "Transf√©r√©s : $TRANSFERRED"
    echo "Supprim√©s : $DELETED"
    echo "Renomm√©s : $RENAMED"
    echo "======================================"
  fi
fi


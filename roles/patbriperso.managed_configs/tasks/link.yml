---
- name: "Check source exists"
  ansible.builtin.stat:
    path: "{{ managed_configs_root }}/{{ item.src }}"
  register: src_stat

- name: "Fail if source does not exist (non-optional)"
  ansible.builtin.fail:
    msg: >
      Managed config source does not exist:
      {{ managed_configs_root }}/{{ item.src }}
  when:
    - not src_stat.stat.exists
    - not (item.optional | default(false))

- name: "Skip optional link when source is missing"
  ansible.builtin.debug:
    msg: >
      Optional managed config skipped (source missing):
      {{ managed_configs_root }}/{{ item.src }}
  when:
    - not src_stat.stat.exists
    - item.optional | default(false)

- name: "Check destination"
  ansible.builtin.stat:
    path: "{{ item.dest }}"
    follow: false
  register: dest_stat
  when: src_stat.stat.exists

- name: "Backup existing destination"
  ansible.builtin.command:
    cmd: >
      mv "{{ item.dest }}"
         "{{ item.dest }}.bak.{{ ansible_date_time.iso8601 }}"
  when:
    - src_stat.stat.exists
    - dest_stat.stat.exists
    - not dest_stat.stat.islnk
    - (item.backup | default(false)) or (managed_configs_backup | default(false))
  changed_when: true

- name: "Fail if destination exists and is not a symlink (no backup)"
  ansible.builtin.fail:
    msg: >
      Destination exists and is not a symlink (backup disabled):
      {{ item.dest }}
  when:
    - src_stat.stat.exists
    - dest_stat.stat.exists
    - not dest_stat.stat.islnk
    - not (
        (item.backup | default(false))
        or (managed_configs_backup | default(false))
      )

- name: "Create symlink"
  ansible.builtin.file:
    src: "{{ managed_configs_root }}/{{ item.src }}"
    dest: "{{ item.dest }}"
    state: link
  when: src_stat.stat.exists
